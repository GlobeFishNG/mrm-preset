/**
 * This file was automatically generated by \`yarn openapi:codegen\`.
 * DO NOT MODIFY IT MANUALLY. Instead, modify the source OpenAPI/Swagger YAML file,
 * and run \`yarn openapi:codegen\` to regenerate this file.
 */

/* eslint-disable prefer-arrow/prefer-arrow-functions */
// ------- automatically generated code start ---------

import * as express from 'express';
import * as http from 'http';
import * as https from 'https';
import { applog, startInternalService, addTransactionId } from '@ngiq/nodejs-common';
import { router } from './access/<%= app.name %>.router';
import {
  useCustomizedHandlerBeforeRouter,
  useCustomizedHandlerAfterRouter,
  errorHandler,
  healthCheck,
} from './<%= app.name %>.appprocessor';

const logger = applog.logger('<%= app.name %>app');

let internalService: http.Server | https.Server;

export async function start(): Promise<void> {
  internalService = startInternalService(server(), <%= app.port %>, (error: Error) => {
    logger.error('start API <%= app.name %> failed, error is: ', error);
    process.exit(1);
  });
}

export async function stop(): Promise<void> {
  internalService.close();
}

export function server(): express.Express {
  const app = express();
  app.use(express.json());
  app.get('/health', healthCheck);
  app.use(addTransactionId);
  useCustomizedHandlerBeforeRouter(app);
<% if (!app.basePath) { -%>
  app.use(router());
<% } else { -%>
  app.use('<%= app.basePath -%>', router());
<% } -%>
  useCustomizedHandlerAfterRouter(app);
  app.use(errorHandler);
  return app;
}

// ------- automatically generated code stop ---------
/* eslint-enable prefer-arrow/prefer-arrow-functions */